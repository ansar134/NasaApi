<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\703040\Documents\Personal\resume\greenShieldCanada\NasaApi\NasaApiTest\Services\NasaPicFetchingServiceTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.EntityFrameworkCore;
using NasaApi.Models;
using NasaApi.Services.Impl;
using NasaApi.Storage;
using NasaApiTest.Util;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;
using Moq;
using NasaApi.Exceptions;
using Newtonsoft.Json.Linq;
using Xunit;

namespace NasaApiTest.Services
{
    public class NasaPicFetchingServiceTest
    {
        [Fact]
        public async Task ReturnNasaImageForTheDay()
        {
            var optionsBuilder = new DbContextOptionsBuilder&lt;NasaApiDbContext&gt;();
            optionsBuilder.UseInMemoryDatabase(&quot;dbNasaApiPictures&quot;);
            var dbContext = new NasaApiDbContext(optionsBuilder.Options);
            var clientFactory = HttpClientMock.NasaApiHTTPClientFactory(NasaApiResponseBuilder.OkResponse, HttpStatusCode.OK);
            var config = new ConfigurationBuilder().AddJsonFile(&quot;appsettings.json&quot;).Build();
            var systemUnderTest = new NasaPicFetchingService(dbContext, clientFactory, config);
            var result = await systemUnderTest.GetPicOfTheDay(&quot;&quot;);

            Assert.NotNull(result.dataModel);
            Assert.IsType&lt;NasaAstroPicModel&gt;(result.dataModel);

        }

        [Fact]
        public async Task VerifyTheContentsOfResponse()
        {
            var optionsBuilder = new DbContextOptionsBuilder&lt;NasaApiDbContext&gt;();
            optionsBuilder.UseInMemoryDatabase(&quot;dbNasaApiPictures&quot;);
            var dbContext = new NasaApiDbContext(optionsBuilder.Options);
            var clientFactory = HttpClientMock.NasaApiHTTPClientFactory(NasaApiResponseBuilder.OkResponse, HttpStatusCode.OK);
            var config = new ConfigurationBuilder().AddJsonFile(&quot;appsettings.json&quot;).Build();
            var systemUnderTest = new NasaPicFetchingService(dbContext, clientFactory, config);
            var result = await systemUnderTest.GetPicOfTheDay(&quot;&quot;);

            Assert.NotNull(result.dataModel);
            Assert.IsType&lt;NasaAstroPicModel&gt;(result.dataModel);
            Assert.NotEqual(&quot;&quot;,result.dataModel.HdUrl);
            Assert.NotEqual(&quot;&quot;, result.dataModel.Url);
            Assert.NotEqual(&quot;&quot;, result.dataModel.Title);
            Assert.NotEqual(&quot;&quot;, result.dataModel.Title);
            Assert.NotEqual(&quot;&quot;, result.dataModel.Media_Type);

        }


        [Fact]
        public async Task ReturnExceptionWhenDateIsInFuture()
        {
            var optionsBuilder = new DbContextOptionsBuilder&lt;NasaApiDbContext&gt;();
            optionsBuilder.UseInMemoryDatabase(&quot;dbNasaApiPictures&quot;);
            var dbContext = new NasaApiDbContext(optionsBuilder.Options);
            var clientFactory = HttpClientMock.NasaApiHTTPClientFactory(NasaApiResponseBuilder.BadRequestResponse, HttpStatusCode.BadRequest);
            var config = new ConfigurationBuilder().AddJsonFile(&quot;appsettings.json&quot;).Build();
            var systemUnderTest = new NasaPicFetchingService(dbContext, clientFactory, config);
            try
            {
                var result = await systemUnderTest.GetPicOfTheDay(DateTime.Now.AddDays(1).ToString(&quot;yyyy-MM-dd&quot;));
            }
            catch (NasaApiResponseException ex)
            {
                Assert.IsType&lt;NasaApiResponseException&gt;(ex);
                Assert.Equal(HttpStatusCode.BadRequest, ex.StatusCode);
                Assert.NotNull(JToken.Parse(ex.ToJsonString()));
            }

        }
        
        [Fact]
        public async Task ReturnExceptionWhenDateFormatIsWrong()
        {
            var optionsBuilder = new DbContextOptionsBuilder&lt;NasaApiDbContext&gt;();
            optionsBuilder.UseInMemoryDatabase(&quot;dbNasaApiPictures&quot;);
            var dbContext = new NasaApiDbContext(optionsBuilder.Options);
            var clientFactory = HttpClientMock.NasaApiHTTPClientFactory(NasaApiResponseBuilder.BadRequestResponse, HttpStatusCode.BadRequest);
            var config = new ConfigurationBuilder().AddJsonFile(&quot;appsettings.json&quot;).Build();
            var systemUnderTest = new NasaPicFetchingService(dbContext, clientFactory, config);
            try
            {
                var result = await systemUnderTest.GetPicOfTheDay(&quot;2021-5-5&quot;);
            }
            catch (NasaApiResponseException ex)
            {
                Assert.IsType&lt;NasaApiResponseException&gt;(ex);
                Assert.Equal(HttpStatusCode.BadRequest, ex.StatusCode);
                Assert.Equal(&quot;Date format is not correct, it should be in yyyy-MM-dd format&quot;, ex.Message);

            }

        }

        [Fact]
        public async Task ReturnExceptionWhenApiIsUnreachable()
        {
            var optionsBuilder = new DbContextOptionsBuilder&lt;NasaApiDbContext&gt;();
            optionsBuilder.UseInMemoryDatabase(&quot;dbNasaApiPictures&quot;);
            var dbContext = new NasaApiDbContext(optionsBuilder.Options);
            var clientFactory = HttpClientMock.NasaApiHTTPClientExceptionFactory(new HttpClientMock.ExceptionContent(new HttpRequestException(&quot;Api is not reachable&quot;)), HttpStatusCode.InternalServerError);
            var config = new ConfigurationBuilder().AddJsonFile(&quot;appsettings.json&quot;).Build();
            var systemUnderTest = new NasaPicFetchingService(dbContext, clientFactory, config);
            try
            {
                var result = await systemUnderTest.GetPicOfTheDay(&quot;2021-05-05&quot;);
            }
            catch (NasaApiResponseException ex)
            {
                Assert.IsType&lt;NasaApiResponseException&gt;(ex);
                Assert.Equal(HttpStatusCode.InternalServerError, ex.StatusCode);
                Assert.Equal(&quot;Error response from Nasa Api, Api is not reachable&quot;, ex.Message);

            }

        }



        [Fact]
        public async Task ReturnInvalidOperationExceptionFromHttpClient()
        {
            var optionsBuilder = new DbContextOptionsBuilder&lt;NasaApiDbContext&gt;();
            optionsBuilder.UseInMemoryDatabase(&quot;dbNasaApiPictures&quot;);
            var dbContext = new NasaApiDbContext(optionsBuilder.Options);
            var clientFactory = HttpClientMock.NasaApiHTTPClientExceptionFactory(new HttpClientMock.ExceptionContent(new InvalidOperationException(&quot;Invalid Operation&quot;)), HttpStatusCode.InternalServerError);
            var config = new ConfigurationBuilder().AddJsonFile(&quot;appsettings.json&quot;).Build();
            var systemUnderTest = new NasaPicFetchingService(dbContext, clientFactory, config);
            try
            {
                var result = await systemUnderTest.GetPicOfTheDay(&quot;2021-05-05&quot;);
            }
            catch (NasaApiResponseException ex)
            {
                Assert.IsType&lt;NasaApiResponseException&gt;(ex);
                Assert.Equal(HttpStatusCode.InternalServerError, ex.StatusCode);
                Assert.Equal(&quot;Error response from Nasa Api, Invalid Operation&quot;, ex.Message);

            }

        }

        [Fact]
        public async Task ReturnTaskCanceledExceptionFromHttpClient()
        {
            var optionsBuilder = new DbContextOptionsBuilder&lt;NasaApiDbContext&gt;();
            optionsBuilder.UseInMemoryDatabase(&quot;dbNasaApiPictures&quot;);
            var dbContext = new NasaApiDbContext(optionsBuilder.Options);
            var clientFactory = HttpClientMock.NasaApiHTTPClientExceptionFactory(new HttpClientMock.ExceptionContent(new TaskCanceledException(&quot;Task cancelled&quot;)), HttpStatusCode.InternalServerError);
            var config = new ConfigurationBuilder().AddJsonFile(&quot;appsettings.json&quot;).Build();
            var systemUnderTest = new NasaPicFetchingService(dbContext, clientFactory, config);
            try
            {
                var result = await systemUnderTest.GetPicOfTheDay(&quot;2021-05-05&quot;);
            }
            catch (NasaApiResponseException ex)
            {
                Assert.IsType&lt;NasaApiResponseException&gt;(ex);
                Assert.Equal(HttpStatusCode.InternalServerError, ex.StatusCode);
                Assert.Equal(&quot;Error response from Nasa Api, Task cancelled&quot;, ex.Message);

            }

        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,1],[26,13,26,82,1],[27,13,27,69,1],[28,13,28,74,1],[29,13,29,127,1],[30,13,30,93,1],[31,13,31,96,1],[32,13,32,67,1],[34,13,34,46,1],[35,13,35,64,1],[37,9,37,10,1],[41,9,41,10,1],[42,13,42,82,1],[43,13,43,69,1],[44,13,44,74,1],[45,13,45,127,1],[46,13,46,93,1],[47,13,47,96,1],[48,13,48,67,1],[50,13,50,46,1],[51,13,51,64,1],[52,13,52,56,1],[53,13,53,55,1],[54,13,54,57,1],[55,13,55,57,1],[56,13,56,62,1],[58,9,58,10,1],[63,9,63,10,1],[64,13,64,82,1],[65,13,65,69,1],[66,13,66,74,1],[67,13,67,143,1],[68,13,68,93,1],[69,13,69,96,1],[71,13,71,14,1],[72,17,72,115,1],[73,13,73,14,0],[74,13,74,48,1],[75,13,75,14,1],[76,17,76,61,1],[77,17,77,72,1],[78,17,78,65,1],[79,13,79,14,1],[81,9,81,10,1],[85,9,85,10,1],[86,13,86,82,1],[87,13,87,69,1],[88,13,88,74,1],[89,13,89,143,1],[90,13,90,93,1],[91,13,91,96,1],[93,13,93,14,1],[94,17,94,79,1],[95,13,95,14,0],[96,13,96,48,1],[97,13,97,14,1],[98,17,98,61,1],[99,17,99,72,1],[100,17,100,107,1],[102,13,102,14,1],[104,9,104,10,1],[108,9,108,10,1],[109,13,109,82,1],[110,13,110,69,1],[111,13,111,74,1],[112,13,112,205,1],[113,13,113,93,1],[114,13,114,96,1],[116,13,116,14,1],[117,17,117,81,1],[118,13,118,14,0],[119,13,119,48,1],[120,13,120,14,1],[121,17,121,61,1],[122,17,122,81,1],[123,17,123,96,1],[125,13,125,14,1],[127,9,127,10,1],[133,9,133,10,1],[134,13,134,82,1],[135,13,135,69,1],[136,13,136,74,1],[137,13,137,207,1],[138,13,138,93,1],[139,13,139,96,1],[141,13,141,14,1],[142,17,142,81,1],[143,13,143,14,0],[144,13,144,48,1],[145,13,145,14,1],[146,17,146,61,1],[147,17,147,81,1],[148,17,148,93,1],[150,13,150,14,1],[152,9,152,10,1],[156,9,156,10,1],[157,13,157,82,1],[158,13,158,69,1],[159,13,159,74,1],[160,13,160,200,1],[161,13,161,93,1],[162,13,162,96,1],[164,13,164,14,1],[165,17,165,81,1],[166,13,166,14,0],[167,13,167,48,1],[168,13,168,14,1],[169,17,169,61,1],[170,17,170,81,1],[171,17,171,90,1],[173,13,173,14,1],[175,9,175,10,1]]);
    </script>
  </body>
</html>