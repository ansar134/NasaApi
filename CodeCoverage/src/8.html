<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\703040\Documents\Personal\resume\greenShieldCanada\NasaApi\NasaApi\Services\Impl\NasaPicFetchingService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using NasaApi.Models;
using NasaApi.Models.DTOs;
using NasaApi.Storage;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Threading.Tasks;
using NasaApi.Exceptions;

namespace NasaApi.Services.Impl
{
    
    public class NasaPicFetchingService : INasaPicFetchingService
    {
        private readonly IHttpClientFactory _httpClientFactory;
        private readonly NasaApiDbContext _nasaApiDbContext;
        private readonly IConfiguration _configuration;

        
        public NasaPicFetchingService(NasaApiDbContext dbContext, IHttpClientFactory httpClientFactory, IConfiguration configuration) {
            _nasaApiDbContext = dbContext;
            _httpClientFactory = httpClientFactory;
            _configuration = configuration;
        }

        /*
         This is the main method that gets the picture response for the date
         1. Validate the query param i.e. date
         2. Get response from cache
         3. If cache doesnt have then call API.
         4. Update cache
         5. send back reply
         */
        public async Task&lt;ResponseDTO&gt; GetPicOfTheDay(string date)
        {

            string formattedDate = string.IsNullOrEmpty(date)? &quot;&quot; : ValidateAndFormatDateParam(date);
            var returnValue = new ResponseDTO();
            // check the cache contains the response from the data requested
            var cachedDataModel = await GetCachedResponseFromMemoryDbAsync(formattedDate);

            //if cache has data then sent cached data back to the client
            if (cachedDataModel != null)
            {
                // indicate that this is a cached response, mostly for testing and debugging purposes
                returnValue.Message = &quot;CachedResponse&quot;;
                returnValue.dataModel = cachedDataModel;
                return returnValue;
            }

            // so cache doesn&#39;t have the data then fetch from the Nasa API
            else
            {
                try
                {
                    var httpClient = _httpClientFactory.CreateClient();
                    var url = BuildUrl(formattedDate);

                    var response = await httpClient.GetAsync(url);
                    string responseString = await response.Content.ReadAsStringAsync();

                    // if response is a http 200 success, then construct Picture DTO 
                    if (response.IsSuccessStatusCode)
                    {
                        // deserialize JSON into model
                        var data = JsonConvert.DeserializeObject&lt;NasaAstroPicModel&gt;(responseString);
                        returnValue.Message = &quot;Success&quot;;
                        returnValue.dataModel = data;

                        // store the response in cache
                        await AddResponseToCache(data);

                        return returnValue;

                    }
                    else
                    {
                        throw new NasaApiResponseException(response.StatusCode,
                            &quot;Error response from Nasa Api, &quot; + responseString);
                    }
                }
                // checked exceptions coming from HTTP client, these are generalized to internal server errors
                catch (HttpRequestException ex)
                {
                    throw new NasaApiResponseException(ex.StatusCode ?? HttpStatusCode.InternalServerError,
                        &quot;Error response from Nasa Api, &quot; + ex.Message);
                }
                catch (InvalidOperationException ex)
                {
                    throw new NasaApiResponseException(HttpStatusCode.InternalServerError,
                        &quot;Error response from Nasa Api, &quot; + ex.Message);
                }
                catch (TaskCanceledException ex)
                {
                    throw new NasaApiResponseException(HttpStatusCode.InternalServerError,
                        &quot;Error response from Nasa Api, &quot; + ex.Message);
                }

            }
            

        }

        private string ValidateAndFormatDateParam(string date)
        {
            DateTime formattedDateTime;
            if (DateTime.TryParseExact(date, &quot;yyyy-MM-dd&quot;, System.Globalization.CultureInfo.InvariantCulture,
                System.Globalization.DateTimeStyles.None, out formattedDateTime))
            {
                return formattedDateTime.ToString(&quot;yyyy-MM-dd&quot;);
            }
            else
            {

                throw new NasaApiResponseException(HttpStatusCode.BadRequest,
                    &quot;Date format is not correct, it should be in yyyy-MM-dd format&quot;);
            }
        }


        private async Task AddResponseToCache(NasaAstroPicModel data)
        {
            _nasaApiDbContext.NasaAstroPicModel.Add(data);
            await _nasaApiDbContext.SaveChangesAsync();
        }

        private async Task&lt;NasaAstroPicModel&gt; GetCachedResponseFromMemoryDbAsync(string date) 
        {
            // if date is empty then check for today&#39;s date in the cache
            if (string.IsNullOrEmpty(date))
            {
                date = DateTime.Now.ToString(&quot;yyyy-MM-dd&quot;);
            }
            var cacheData =  await _nasaApiDbContext.NasaAstroPicModel.Where(x =&gt; x.Date == date).ToListAsync();
            if (cacheData.Count == 0)
                return null;

            return cacheData[0];
        }

        private string BuildUrl(string date)
        {
            string nasaUri = _configuration[&quot;NasaUrl&quot;];
            if (!string.IsNullOrEmpty(date))
            {
                nasaUri += &quot;&amp;date=&quot; + date;
            }

            return nasaUri;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,134,1],[25,135,25,136,1],[26,13,26,43,1],[27,13,27,52,1],[28,13,28,44,1],[29,9,29,10,1],[40,9,40,10,1],[42,13,42,102,1],[43,13,43,49,1],[45,13,45,91,1],[48,13,48,41,1],[49,13,49,14,1],[51,17,51,56,1],[52,17,52,57,1],[53,17,53,36,1],[58,13,58,14,1],[60,17,60,18,1],[61,21,61,72,1],[62,21,62,55,1],[64,21,64,67,1],[65,21,65,88,1],[68,21,68,54,1],[69,21,69,22,1],[71,25,71,101,1],[72,25,72,57,1],[73,25,73,54,1],[76,25,76,56,1],[78,25,78,44,1],[82,21,82,22,1],[83,25,84,80,1],[88,17,88,48,1],[89,17,89,18,1],[90,21,91,72,1],[93,17,93,53,1],[94,17,94,18,1],[95,21,96,72,1],[98,17,98,49,1],[99,17,99,18,1],[100,21,101,72,1],[107,9,107,10,1],[110,9,110,10,1],[112,13,113,82,1],[114,13,114,14,1],[115,17,115,65,1],[118,13,118,14,1],[120,17,121,86,1],[123,9,123,10,1],[127,9,127,10,1],[128,13,128,59,1],[129,13,129,56,1],[130,9,130,10,1],[133,9,133,10,1],[135,13,135,44,1],[136,13,136,14,1],[137,17,137,60,1],[138,13,138,14,1],[139,13,139,113,1],[140,13,140,38,1],[141,17,141,29,1],[143,13,143,33,1],[144,9,144,10,1],[147,9,147,10,1],[148,13,148,56,1],[149,13,149,45,1],[150,13,150,14,1],[151,17,151,44,1],[152,13,152,14,1],[154,13,154,28,1],[155,9,155,10,1]]);
    </script>
  </body>
</html>